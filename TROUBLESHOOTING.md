# 🔧 トラブルシューティング集：CI/CD & 文字コード編

本ドキュメントは、Windows環境（Visual Studio）で開発し、GitHub Actions（Linux環境）でテストを実行した際に発生したエラーとその解決策のまとめです。
「手元では動くのに、GitHubに上げると動かない」という現象の多くは、文字コード（Shift-JIS vs UTF-8）に起因します。

## 目次

- [🔧 トラブルシューティング集：CI/CD \& 文字コード編](#-トラブルシューティング集cicd--文字コード編)
  - [目次](#目次)
  - [1. ビルドエラー：Too many characters in character literal](#1-ビルドエラーtoo-many-characters-in-character-literal)
    - [🚨 事象](#-事象)
    - [🔍 原因](#-原因)
    - [✅ 解決策](#-解決策)
  - [2. テスト失敗：日本語が文字化けして Assert に失敗する](#2-テスト失敗日本語が文字化けして-assert-に失敗する)
    - [🚨 事象](#-事象-1)
    - [🔍 原因](#-原因-1)
    - [✅ 解決策](#-解決策-1)
  - [3. テスト失敗：見た目は同じなのに一致しない（℃ 問題）](#3-テスト失敗見た目は同じなのに一致しない-問題)
    - [🚨 事象](#-事象-2)
    - [🔍 原因](#-原因-2)
    - [✅ 解決策](#-解決策-2)
  - [4. 根本対策：チーム開発での事故を防ぐ設定](#4-根本対策チーム開発での事故を防ぐ設定)
    - [🛡️ `.editorconfig` の導入](#️-editorconfig-の導入)
    - [🛡️ アプリ側での Shift-JIS 許可](#️-アプリ側での-shift-jis-許可)

---

## 1. ビルドエラー：Too many characters in character literal

### 🚨 事象

GitHub Actions 上での `dotnet build` 時に以下のコンパイルエラーが発生し、ビルドが失敗する。

```text
Error: .../ValidationServiceTests.cs(98,99): error CS1012: Too many characters in character literal
```

### 🔍 原因

ソースコードの文字コードが **Shift-JIS** になっていたため。
Linux環境（GitHub Actions）のコンパイラは、デフォルトでは Shift-JIS を理解できない。その結果、日本語の文字（例：`'説'`）を「1文字」ではなく「3バイトのデータの並び」として解釈してしまい、「`char` 型には1文字しか入らないのに、複数文字が入っている」と判定された。

### ✅ 解決策

対象のソースコードファイル（`.cs`）を **「UTF-8 シグネチャ付き (BOM付き)」** で保存し直す。

**Visual Studio での手順:**

1. 対象ファイルを開く。
2. **[ファイル]** > **[名前を付けて保存]** を選択。
3. 保存ボタン横の「▼」から **[エンコード付きで保存]** を選択。
4. **「Unicode (UTF-8 シグネチャ付き) - コードページ 65001」** を選んで上書き保存。

---

## 2. テスト失敗：日本語が文字化けして Assert に失敗する

### 🚨 事象

ビルドは通るが、単体テストで `Assert.Contains` が失敗する。
ログを見ると、期待値（Expected）は正しい日本語だが、実際の値（Actual）が文字化けしている。

```text
String:    "[E008] 定数名..."
Not found: "Œ`Ž®‚ª•s³"  <-- 文字化けしている
```

### 🔍 原因

テストコード（`Tests.cs`）自体が **Shift-JIS** で保存されていたため。
Linux環境のコンパイラがソースコード内の日本語文字列を正しく読み込めず、デタラメな文字としてコンパイルしてしまった結果、テスト実行時の検索対象文字列がおかしくなっていた。

### ✅ 解決策

事象1と同様、テストコードのファイルも **「UTF-8 シグネチャ付き (BOM付き)」** に変換して保存し直す。

---

## 3. テスト失敗：見た目は同じなのに一致しない（℃ 問題）

### 🚨 事象

CSV読み込みテストにおいて、「℃」などの特殊文字を含むデータの比較で失敗する。ログ上では両方とも「℃」に見える。

```text
Assert.Contains() Failure: Filter not matched in collection
Expected: ... 25 ℃
Actual:   ... 25 ℃
```

### 🔍 原因

**機種依存文字（環境依存文字）** の問題。
Windows (Shift-JIS) と Linux (UTF-8) の間で変換を行う際、`℃` (摂氏記号) や `①` (丸数字) などは、OSによって微妙に異なるバイナリ（コードポイント）に変換されることがある。そのため、文字としては同じに見えても、プログラム上の厳密な一致判定（Equals）では `false` になる。

### ✅ 解決策

テストデータやテストコードにおいて、**機種依存文字の使用を避ける**のが最善策。

- **NG**: `℃`, `①`, `㈱`, `髙`
- **OK**: `度`, `(1)`, `(株)`, `高`

どうしても必要な場合は、比較前に `string.Normalize()` を行って正規化する実装が必要だが、テストの安定性を考えると文字自体を変えるほうが安全。

---

## 4. 根本対策：チーム開発での事故を防ぐ設定

個別に「名前を付けて保存」を行う運用は忘れやすいため、以下の設定ファイルを導入して自動化する。

### 🛡️ `.editorconfig` の導入

リポジトリのルート直下に `.editorconfig` を配置し、全ファイルの文字コードを強制する。これにより、誰がどの環境で保存しても勝手に UTF-8 (BOM付き) になる。

```ini
root = true

[*]
end_of_line = crlf
charset = utf-8-bom  # ここが重要（BOM付きにする）
```

### 🛡️ アプリ側での Shift-JIS 許可

.NET Core / .NET 5以降の環境（Linux含む）には、標準で Shift-JIS の定義が含まれていない。
Shift-JIS のファイルを読み書きする場合は、プログラムの起動時（`Program.cs` やテストのコンストラクタ）に以下を記述する必要がある。

```csharp
// Shift-JIS を使えるようにするおまじない
System.Text.Encoding.RegisterProvider(System.Text.CodePagesEncodingProvider.Instance);
```

また、読み込み時は `Encoding.Default`（環境依存）ではなく、明示的に指定する。

```csharp
// 安全な書き方
var encoding = Encoding.GetEncoding("Shift_JIS");
```
